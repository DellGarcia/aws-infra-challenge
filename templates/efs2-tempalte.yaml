AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Template do CloudFormation para criar um sistema de arquivos EFS, dois
  mount targets e uma Launch Configuration para instâncias do Amazon Linux.

Parameters:
  VPC:
    Type: AWS::EC2::VPC::Id

  PrivateSubnets:
    Description: Subnets to be used
    Type: List<AWS::EC2::Subnet::Id>

Resources:
  # Crie um sistema de arquivos EFS
  EFSFileSystem:
    Type: 'AWS::EFS::FileSystem'
    Properties:
      Encrypted: true
      PerformanceMode: 'generalPurpose'
      ThroughputMode: 'bursting'
      FileSystemTags:
        - Key: Name
          Value: 'AWS-Infra-FS'

  # Crie um Security Group para permitir o acesso NFS
  EFSSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security Group para acesso ao EFS via NFS'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          CidrIp: '0.0.0.0/0' # Recomenda-se restringir a um CIDR mais específico


  # Crie o primeiro mount target na Subnet 1
  MountTargetSubnet1:
    Type: 'AWS::EFS::MountTarget'
    Properties:
      FileSystemId: !Ref EFSFileSystem
      SubnetId: !Select
        - 0
        - !Ref PrivateSubnets
      SecurityGroups:
        - !GetAtt EFSSecurityGroup.GroupId
    DependsOn: EFSFileSystem

  # Crie o segundo mount target na Subnet 2
  MountTargetSubnet2:
    Type: 'AWS::EFS::MountTarget'
    Properties:
      FileSystemId: !Ref EFSFileSystem
      SubnetId: !Select
        - 1
        - !Ref PrivateSubnets
      SecurityGroups:
        - !GetAtt EFSSecurityGroup.GroupId
    DependsOn: EFSFileSystem

